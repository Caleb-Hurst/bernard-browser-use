name: Summarize Issue and Linked PRs in Project Review

on:
  schedule:
    - cron: '* * * * *' # every minute; GitHub may delay runs

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Find issues in Review status
        id: find-review-issues
        env:
          GH_TOKEN: ${{ secrets.BERNARD_BROWSER_AGENT_SUMMARY }}
        run: |
          set -euo pipefail

          PROJECT_ID="PVT_kwHOBtn0hM4BEg5v"
          STATUS_FIELD_ID="PVTSSF_lAHOBtn0hM4BEg5vzg2Hmgo"
          REVIEW_OPTION_ID="df73e18b"

          # Query all items in the project with "Review" status
          gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      content {
                        ... on Issue { number }
                      }
                      fieldValues(first: 20) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            field {
                              ... on ProjectV2Field {
                                id
                              }
                            }
                            optionId
                          }
                          ... on ProjectV2ItemFieldTextValue { __typename }
                          ... on ProjectV2ItemFieldNumberValue { __typename }
                          ... on ProjectV2ItemFieldDateValue { __typename }
                          ... on ProjectV2ItemFieldIterationValue { __typename }
                          ... on ProjectV2ItemFieldRepositoryValue { __typename }
                          ... on ProjectV2ItemFieldUserValue { __typename }
                          ... on ProjectV2ItemFieldLabelValue { __typename }
                          ... on ProjectV2ItemFieldMilestoneValue { __typename }
                          ... on ProjectV2ItemFieldPullRequestValue { __typename }
                          ... on ProjectV2ItemFieldReviewerValue { __typename }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' > items.json

          # Extract issue numbers in Review
          ISSUE_NUMBERS=$(jq -r --arg STATUS_FIELD_ID "$STATUS_FIELD_ID" --arg REVIEW_OPTION_ID "$REVIEW_OPTION_ID" '
            .data.node.items.nodes[]
            | select(.fieldValues.nodes[]?
                | select(.field.field.id == $STATUS_FIELD_ID and .optionId == $REVIEW_OPTION_ID))
            | .content.number
          ' items.json | xargs)

          echo "ISSUE_NUMBERS=$ISSUE_NUMBERS" >> $GITHUB_ENV

      - name: Summarize with Copilot
        if: env.ISSUE_NUMBERS != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          for ISSUE_NUMBER in $ISSUE_NUMBERS; do
            # Skip if already summarized, e.g., check for a specific label or comment
            SUMMARY_COMMENT=$(gh issue view "$ISSUE_NUMBER" --json comments --jq '.comments[].body' | grep '### Copilot Summary' || true)
            if [ -n "$SUMMARY_COMMENT" ]; then
              echo "Issue #$ISSUE_NUMBER already summarized, skipping."
              continue
            fi

            PRS=$(gh pr list --search "#$ISSUE_NUMBER" --json number --jq '.[].number')
            PR_URLS=""
            for PR in $PRS; do
              PR_URLS="$PR_URLS https://github.com/$REPO/pull/$PR"
            done

            PROMPT="Summarize issue #$ISSUE_NUMBER and the following linked pull requests: $PR_URLS. For each PR, summarize the main code changes and provide a test plan describing how to verify the implementation is correct."

            gh copilot agent-task \
              --issue "$ISSUE_NUMBER" \
              --prompt "$PROMPT" \
              --post-comment
          done
