name: Summarize Issue and Linked PRs in Project Review

on:
  schedule:
    - cron: '* * * * *' # every 2 minutes

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Find issues in Review status
        id: find-review-issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID="YOUR_PROJECT_NODE_ID"
          STATUS_FIELD_ID="YOUR_STATUS_FIELD_NODE_ID"
          REVIEW_OPTION_ID="YOUR_REVIEW_OPTION_NODE_ID"

          # Query all items in the project with "Review" status
          gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  items(first: 30) {
                    nodes {
                      content {
                        ... on Issue { number }
                      }
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            field {
                              id
                            }
                            optionId
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' > items.json

          # Extract issue numbers in Review
          ISSUE_NUMBERS=$(jq -r --arg STATUS_FIELD_ID "$STATUS_FIELD_ID" --arg REVIEW_OPTION_ID "$REVIEW_OPTION_ID" '
            .data.node.items.nodes[]
            | select(.fieldValues.nodes[]?
                | select(.field.id == $STATUS_FIELD_ID and .optionId == $REVIEW_OPTION_ID))
            | .content.number
          ' items.json | xargs)

          echo "ISSUE_NUMBERS=$ISSUE_NUMBERS" >> $GITHUB_ENV

      - name: Summarize with Copilot
        if: env.ISSUE_NUMBERS != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          for ISSUE_NUMBER in $ISSUE_NUMBERS; do
            # Skip if already summarized, e.g., check for a specific label or comment
            SUMMARY_COMMENT=$(gh issue view $ISSUE_NUMBER --json comments --jq '.comments[].body' | grep '### Copilot Summary')
            if [ -n "$SUMMARY_COMMENT" ]; then
              echo "Issue #$ISSUE_NUMBER already summarized, skipping."
              continue
            fi

            PRS=$(gh pr list --search "#$ISSUE_NUMBER" --json number --jq '.[].number')
            PR_URLS=""
            for PR in $PRS; do
              PR_URLS="$PR_URLS https://github.com/$REPO/pull/$PR"
            done
            PROMPT="Summarize issue #$ISSUE_NUMBER and the following linked pull requests: $PR_URLS. For each PR, summarize the main code changes and provide a test plan describing how to verify the implementation is correct."
            gh copilot agent-task \
              --issue "$ISSUE_NUMBER" \
              --prompt "$PROMPT" \
              --post-comment
          done
